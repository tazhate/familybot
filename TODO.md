# TODO — FamilyBot

## Критично (нужно для базового использования)

### Модель Person
- [x] Создать таблицу `persons` (id, user_id, name, role, birthday, notes, created_at)
- [x] role: child, family, contact, partner_child
- [x] CRUD операции в storage
- [x] Команда `/people` — список людей
- [x] Команда `/addperson Тим ребёнок 12.06.2017` — добавить человека
- [x] Связь задач с людьми (task.person_id)

### Команда /week
- [x] Модель WeeklyEvent (day_of_week, time_start, time_end, title, reminder_before, person_id, floating)
- [x] Таблица `weekly_events`
- [x] Команда `/week` — показать расписание на неделю
- [x] Команда `/addweekly` — добавить событие
- [x] Команда `/delweekly` — удалить событие
- [x] Команда `/seedweek` — заполнить расписание:
  - Пн 16:00 — Психолог
  - Пн 17:30 — Федя на спорт
  - Вт 09:00 — Дежурство Allnodes
  - Ср 16:00-20:00 — Тимофей
  - Чт 15:00-18:00 — Созвон Allnodes
  - Пт 15:00 — Выезд к психологу Тима
  - Сб 10:00-20:00 — Тимофей
  - Сб/Вс 12:00-21:00 — Лука (плавающее)

### Напоминания о ДР
- [x] При создании Person с birthday — автосоздание yearly reminder
- [x] Напоминание за 7 дней, за 1 день, в день
- [x] Команда `/birthdays` — ближайшие ДР
- [x] Команда `/seedpeople` — добавить дефолтных людей:
  - Тим 12.06.2017
  - Лука 18.09.2021
  - Ира 17.12
  - Федя 23.09

### Плавающие события
- [x] Интерфейс для floating reminders (`/addfloating`, `/floating`)
- [x] Модель с поддержкой floating_days, confirmed_day, confirmed_week
- [x] Кнопки для выбора дня (через `/floating`)
- [x] Напоминание в пятницу 10:00: "Плавающие события на выходные"
- [x] После выбора — напоминание за 30 мин (дефолт для floating)

### Контекстные напоминания
- [x] Напоминание за N минут до события (reminder_before в weekly_events)
- [x] Scheduler проверяет события и отправляет напоминания
- [x] Улучшенный формат: "Через 30 мин — Событие (16:00)"
- [x] "Через 1 час — Событие (15:00)"

---

## Важно (удобство)

### Команды /assign, /shared
- [x] `/assign 5 @ира` — назначить задачу #5 Ире
- [x] Мульти-чат поддержка (личные + групповые задачи)
- [x] `/shared` — список общих семейных задач
- [x] `/share ID` — сделать задачу общей
- [x] Уведомление партнёру о назначенной задаче
- [x] При создании задачи кнопка "Сделать общей"

### Теги/контексты
- [x] Парсинг тегов из текста: @тим, @ира → автосвязь с Person
- [x] Фильтрация `/list @тим` — только задачи с тегом
- [x] Автотег при связи с Person

### Дата в задаче
- [x] Парсинг даты из текста: "завтра", "в понедельник", "4 февраля"
- [x] `/add помыть машину завтра` → due_date = tomorrow
- [x] NLP для русских дат (послезавтра, через неделю, в пятницу)
- [x] Форматы: DD.MM, DD.MM.YYYY, "20 января"

### Повторные напоминания
- [x] Если задача urgent и не выполнена — напомнить через 2 часа
- [x] Кнопка "Отложить на час" / "Отложить на завтра"
- [x] Счётчик напоминаний (не спамить бесконечно)

### Статусы Allnodes
- [x] Отдельное напоминание (не в брифинге): "Напиши утренний статус"
- [x] Утро: "Что планируешь сегодня?"
- [x] Вечер: "Что сделал за день?"
- [x] Кнопка "Выполнено" для отметки (через повторяющиеся задачи)

---

## Позже (расширения)

### Модель Auto
- [x] Таблица `autos` (id, user_id, name, year, insurance_until, maintenance_until, notes)
- [ ] Машины:
  - Ford F-150 Raptor 1gen 2014 (мой)
  - Lexus 2015 (Иры)
  - Peugeot 4008 2012 (мамы)
- [ ] Напоминания о страховке за 30, 7, 1 день
- [ ] Напоминания о ТО
- [x] Команда `/autos` — список машин
- [x] Команда `/addauto` — добавить машину
- [x] Команда `/insurance` — указать дату страховки
- [x] Команда `/maintenance` — указать дату ТО
- [x] Команда `/seedautos` — заполнить тестовыми данными

### Чек-листы
- [x] Таблица `checklists` (id, user_id, title, items JSON)
- [x] Команда `/checklist Тим` — показать чек-лист
- [x] Команда `/checklists` — список чек-листов
- [x] Команда `/addchecklist` — создать чек-лист
- [x] Команда `/seedchecklists` — чек-лист "Тим"
- [x] Кнопки для отметки пунктов
- [x] Сброс всех пунктов

### Интеграция weekly → reminders
- [x] Автосоздание напоминаний из weekly_events (scheduler проверяет события)
- [x] Синхронизация при изменении расписания (работает по дизайну — polling)
- [x] Команда `/addweekly Пн 17:30 Федя спорт` — добавить в расписание

### Повторяющиеся задачи
- [x] Модель: repeat_type (daily, weekdays, weekly, monthly)
- [x] repeat_time для указания времени напоминания
- [x] При выполнении создаётся новая задача на следующий раз
- [x] Команда `/addrepeat ТИП ЧЧ:ММ Название`
- [x] Команда `/seedallnodes` — создать задачи статусов
- [x] Напоминания по времени через scheduler

### Регулярные задачи по датам
- [x] Дежурство Пт 2-й недели месяца (`/addrepeat monthly_nth 2 Пт 09:00 Дежурство`)
- [x] Логика определения недели месяца (`domain.NthWeekdayOfMonth`, `domain.WeekOfMonth`)

---

### Напоминания по задачам
- [x] Таблица `task_reminders` (task_id, remind_before, sent_at)
- [x] Команда `/remind ID 1д,1ч` — добавить напоминания к задаче
- [x] Интервалы: неделя, день, 3ч, час, 30м
- [x] Scheduler проверяет и отправляет напоминания по due_date
- [x] При выполнении/удалении задачи — напоминания не отправляются

---

## Баги и улучшения

- [x] Пагинация в `/list` если много задач
- [x] Редактирование задачи (`/edit ID поле значение`)
- [x] Редактирование напоминания (`/editreminder ID поле значение`)
- [x] Удаление с подтверждением
- [x] История выполненных задач `/history`
- [x] Статистика `/stats` — сколько выполнено за неделю/месяц
- [x] Команда `/del ID` — удаление задачи
- [x] Постоянная кнопка меню в Telegram (setMyCommands)

---

## Текущее расписание Дениса (для справки)

| День | Время | Что |
|------|-------|-----|
| Понедельник | 16:00 | Психолог |
| Понедельник | 17:30 | Федя на спорт |
| Вторник | — | Дежурство Allnodes |
| Среда | 16:00-20:00 | Тимофей |
| Четверг | 15:00-18:00 | Созвон Allnodes (3 часа) |
| Пятница | 15:00 выезд | Психолог Тима (16:00), потом с ночёвкой |
| Пятница 2-й недели | — | Дежурство Allnodes |
| Суббота | → 20:00 | Тимофей |
| Сб или Вс (плавает) | 12:00-21:00 | Лука |

### Ежедневно
- Утро: статус Allnodes (что планирую)
- Вечер: статус Allnodes (что сделал)

### Ежемесячно
- 4-е число: отчёт Apostol

### Дни рождения
- Тим: 12 июня 2017
- Лука: 18 сентября 2021
- Ира: 17 декабря
- Федя: 23 сентября
